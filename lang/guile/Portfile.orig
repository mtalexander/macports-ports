# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem 1.0
PortGroup	muniversal 1.0

name                guile
<<<<<<< HEAD
version             2.0.14
revision            2
||||||| merged common ancestors
version             2.0.14
=======
version             2.2.2
#revision            0
>>>>>>> master
categories          lang
maintainers         nomaintainer
platforms           darwin
license             LGPL-2.1+

description         GNU's Ubiquitous Intelligent Language for Extension (guile)
long_description    \
        Guile is an interpreter for the Scheme programming \
        language, packaged for use in a wide variety of \
        environments. Guile implements Scheme as described in \
        the Revised^5 Report on the Algorithmic Language Scheme \
        (usually known as R5RS), providing clean and general \
        data and control structures. \
\
        Guile goes beyond the rather austere language presented \
        in R5RS, extending it with a module system, full access \
        to POSIX system calls, networking support, multiple \
        threads, dynamic linking, a foreign function call \
        interface, powerful string processing, and many other \
        features needed for programming in the real world.

distname            guile-${version}
homepage            http://www.gnu.org/software/guile/guile.html
master_sites        gnu

checksums           rmd160  1299dac3a5c218b6aebd7471c6562a9ad7825edc \
                    sha256  3d9b94183b19f04dd4317da87beedafd1c947142f3d861ca1f0224e7a75127ee

depends_build       port:coreutils
                
depends_lib         port:readline \
                    port:gettext \
                    port:libiconv \
                    port:libtool \
                    port:gmp \
                    port:libunistring \
                    port:boehmgc \
                    port:libffi \
                    port:ncurses
                    
depends_run         port:bash

# guile-config is a wrapper around pkg-config
depends_lib-append  port:pkgconfig

# llvm-gcc miscompiles guile
compiler.blacklist *llvm-gcc-4.2

configure.args      CPPFLAGS="-I${prefix}/include" \
                    LDFLAGS="-L${prefix}/lib" \
                    --infodir="${prefix}/share/info" \
                    --mandir="${prefix}/share/man" \
                    --enable-regex \
                    --disable-error-on-warning \
                    --disable-silent-rules

# Unable to cross compile, so we need to be able to run the built code
if {${os.arch} eq "i386" && ${os.major} >= 11} {
    supported_archs i386 x86_64
    set universal_archs_supported {i386 x86_64}
} elseif {${os.arch} eq "i386" && ${build_arch} eq "x86_64"} {
    supported_archs i386 x86_64 ppc
    set universal_archs_supported {i386 x86_64 ppc}
} elseif {${os.arch} eq "i386"} {
    supported_archs i386 ppc
    set universal_archs_supported {i386 ppc}
} elseif {${build_arch} eq "ppc64"} {
    supported_archs ppc ppc64
    set universal_archs_supported {ppc ppc64}
} else {
    supported_archs ${build_arch}
    set universal_archs_supported ${build_arch}
}

platform darwin {
    if {[variant_isset universal]} {
        set merger_host(x86_64) x86_64-apple-${os.platform}${os.major}
        set merger_host(i386) i686-apple-${os.platform}${os.major}
        set merger_host(ppc64) powerpc64-apple-${os.platform}${os.major}
        set merger_host(ppc) powerpc-apple-${os.platform}${os.major}
        set merger_configure_args(x86_64) "--build=x86_64-apple-${os.platform}${os.major}"
        set merger_configure_args(i386) "--build=i686-apple-${os.platform}${os.major}"
        set merger_configure_args(ppc) "--build=powerpc-apple-${os.platform}${os.major}"
        set merger_configure_args(ppc64) "--build=powerpc64-apple-${os.platform}${os.major}"
    } elseif {${build_arch} eq "i386"} {
        configure.args-append \
            --host=i686-apple-${os.platform}${os.major} \
            --build=i686-apple-${os.platform}${os.major}
    } elseif {${build_arch} eq "x86_64"} {
        configure.args-append \
            --host=x86_64-apple-${os.platform}${os.major} \
            --build=x86_64-apple-${os.platform}${os.major}
    } elseif {${build_arch} eq "ppc"} {
        configure.args-append \
            --host=powerpc-apple-${os.platform}${os.major} \
            --build=powerpc-apple-${os.platform}${os.major}
    } elseif {${build_arch} eq "ppc64"} {
        configure.args-append \
            --host=powerpc64-apple-${os.platform}${os.major} \
            --build=powerpc64-apple-${os.platform}${os.major}
    }
}


platform darwin {
	post-destroot {
		system "cd ${destroot}${prefix}/lib/ && \
		ln -s libguilereadline-v-18.18.dylib libguilereadline-v-18.so"
        reinplace "s|#!/bin/sh|#!${prefix}/bin/sh|" ${destroot}${prefix}/bin/guild
	}
}

variant debug {
        configure.cflags -O0 -g
        configure.cxxflags -O0 -g
        configure.f90flags -O0 -g
        configure.fflags -O0 -g
}

livecheck.type  regex
livecheck.url   "http://ftp.gnu.org/pub/gnu/guile/?C=N;O=D"
livecheck.regex "${name}-(\\d+(?:\\.\\d+)*)${extract.suffix}"
